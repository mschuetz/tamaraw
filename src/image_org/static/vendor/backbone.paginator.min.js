/*! backbone.paginator - v0.1.54 - 10/17/2012
* http://github.com/addyosmani/backbone.paginator
* Copyright (c) 2012 Addy Osmani; Licensed MIT */
Backbone.Paginator=function(e,t,n){"use strict";var r={};return r.version="0.15",r.clientPager=e.Collection.extend({useDiacriticsPlugin:!0,useLevenshteinPlugin:!0,sortColumn:"",sortDirection:"desc",lastSortColumn:"",fieldFilterRules:[],lastFieldFilterRules:[],filterFields:"",filterExpression:"",lastFilterExpression:"",defaults_ui:{firstPage:0,currentPage:1,perPage:5,totalPages:10},initialize:function(){this.on("add",this.addModel,this),this.on("remove",this.removeModel,this),this.setDefaults()},setDefaults:function(){var e=t.defaults(this.paginator_ui,this.defaults_ui);t.defaults(this,e)},addModel:function(e){this.origModels.push(e)},removeModel:function(e){var n=t.indexOf(this.origModels,e);this.origModels.splice(n,1)},sync:function(e,r,i){var s=this;this.setDefaults();var o={};t.each(s.server_api,function(e,n){t.isFunction(e)&&(e=t.bind(e,s),e=e()),o[n]=e});var u=t.clone(s.paginator_core);return t.each(u,function(e,n){t.isFunction(e)&&(e=t.bind(e,s),e=e()),u[n]=e}),u=t.defaults(u,{timeout:25e3,cache:!1,type:"GET",dataType:"jsonp"}),u=t.extend(u,{data:decodeURIComponent(n.param(o)),processData:!1,url:t.result(u,"url")},i),n.ajax(u)},nextPage:function(){this.currentPage<this.information.totalPages&&(this.currentPage=++this.currentPage,this.pager())},previousPage:function(){this.currentPage=--this.currentPage||1,this.pager()},goTo:function(e){e!==undefined&&(this.currentPage=parseInt(e,10),this.pager())},howManyPer:function(e){if(e!==undefined){var t=this.perPage;this.perPage=parseInt(e,10),this.currentPage=Math.ceil((t*(this.currentPage-1)+1)/e),this.pager()}},setSort:function(e,t){e!==undefined&&t!==undefined&&(this.lastSortColumn=this.sortColumn,this.sortColumn=e,this.sortDirection=t,this.pager(),this.info())},setFieldFilter:function(e){t.isEmpty(e)||(this.lastFieldFilterRules=this.fieldFilterRules,this.fieldFilterRules=e,this.pager(),this.info())},doFakeFieldFilter:function(e){if(!t.isEmpty(e)){var n=this.lastFieldFilterRules,r=this.fieldFilterRules;this.lastFieldFilterRules=this.fieldFilterRules,this.fieldFilterRules=e,this.pager(),this.info();var i=this.models.length;return this.lastFieldFilterRules=n,this.fieldFilterRules=r,this.pager(),this.info(),i}},setFilter:function(e,t){e!==undefined&&t!==undefined&&(this.filterFields=e,this.lastFilterExpression=this.filterExpression,this.filterExpression=t,this.pager(),this.info())},doFakeFilter:function(e,t){if(e!==undefined&&t!==undefined){var n=this.filterFields,r=this.lastFilterExpression,i=this.filterExpression;this.filterFields=e,this.lastFilterExpression=this.filterExpression,this.filterExpression=t,this.pager(),this.info();var s=this.models.length;return this.filterFields=n,this.lastFilterExpression=r,this.filterExpression=i,this.pager(),this.info(),s}},pager:function(){var e=this,n=this.perPage,r=(e.currentPage-1)*n,i=r+n;e.origModels===undefined&&(e.origModels=e.models),e.models=e.origModels,this.sortColumn!==""&&(e.models=e._sort(e.models,this.sortColumn,this.sortDirection)),t.isEmpty(this.fieldFilterRules)||(e.models=e._fieldFilter(e.models,this.fieldFilterRules)),this.filterExpression!==""&&(e.models=e._filter(e.models,this.filterFields,this.filterExpression));if(this.lastSortColumn!==this.sortColumn||this.lastFilterExpression!==this.filterExpression||!t.isEqual(this.fieldFilterRules,this.lastFieldFilterRules))r=0,i=r+n,e.currentPage=1,this.lastSortColumn=this.sortColumn,this.lastFieldFilterRules=this.fieldFilterRules,this.lastFilterExpression=this.filterExpression;e.sortedAndFilteredModels=e.models,e.reset(e.models.slice(r,i))},_sort:function(e,t,n){return e=e.sort(function(e,r){var i=e.get(t),s=r.get(t);if(!i||!s)return 0;i=i.toString().toLowerCase(),s=s.toString().toLowerCase();if(n==="desc")if(!i.match(/[^\d\.]/)&&i.match(/[\d\.]*/)&&!s.match(/[^\d\.]/)&&s.match(/[\d\.]*/)){if(i-0<s-0)return 1;if(i-0>s-0)return-1}else{if(i<s)return 1;if(i>s)return-1}else if(!i.match(/[^\d\.]/)&&i.match(/[\d\.]*/)&&!s.match(/[^\d\.]/)&&s.match(/[\d\.]*/)){if(i-0<s-0)return-1;if(i-0>s-0)return 1}else{if(i<s)return-1;if(i>s)return 1}return 0}),e},_fieldFilter:function(e,n){if(t.isEmpty(n))return e;var r=[];return t.each(e,function(e){var i=!0;t.each(n,function(n){if(!i)return!1;i=!1;if(n.type==="function"){var r=t.wrap(n.value,function(t){return t(e.get(n.field))});r()&&(i=!0)}else n.type==="required"?t.isEmpty(e.get(n.field).toString())||(i=!0):n.type==="min"?!t.isNaN(Number(e.get(n.field)))&&!t.isNaN(Number(n.value))&&Number(e.get(n.field))>=Number(n.value)&&(i=!0):n.type==="max"?!t.isNaN(Number(e.get(n.field)))&&!t.isNaN(Number(n.value))&&Number(e.get(n.field))<=Number(n.value)&&(i=!0):n.type==="range"?!t.isNaN(Number(e.get(n.field)))&&t.isObject(n.value)&&!t.isNaN(Number(n.value.min))&&!t.isNaN(Number(n.value.max))&&Number(e.get(n.field))>=Number(n.value.min)&&Number(e.get(n.field))<=Number(n.value.max)&&(i=!0):n.type==="minLength"?e.get(n.field).toString().length>=n.value&&(i=!0):n.type==="maxLength"?e.get(n.field).toString().length<=n.value&&(i=!0):n.type==="rangeLength"?t.isObject(n.value)&&!t.isNaN(Number(n.value.min))&&!t.isNaN(Number(n.value.max))&&e.get(n.field).toString().length>=n.value.min&&e.get(n.field).toString().length<=n.value.max&&(i=!0):n.type==="oneOf"?t.isArray(n.value)&&t.include(n.value,e.get(n.field))&&(i=!0):n.type==="equalTo"?n.value===e.get(n.field)&&(i=!0):n.type==="pattern"?e.get(n.field).toString().match(n.value)&&(i=!0):i=!1}),i&&r.push(e)}),r},_filter:function(n,r,i){var s=this,o={};t.isString(r)?o[r]={cmp_method:"regexp"}:t.isArray(r)?t.each(r,function(e){o[e]={cmp_method:"regexp"}}):t.each(r,function(e,n){o[n]=t.defaults(e,{cmp_method:"regexp"})}),r=o,t.has(e.Paginator,"removeDiacritics")&&s.useDiacriticsPlugin&&(i=e.Paginator.removeDiacritics(i));if(i===""||!t.isString(i))return n;var u=t.map(i.match(/\w+/ig),function(e){return e.toLowerCase()}),a="("+t.uniq(u).join("|")+")",f=new RegExp(a,"igm"),l=[];return t.each(n,function(n){var o=[];t.each(r,function(r,a){var l=n.get(a);if(l){var c=[];t.has(e.Paginator,"removeDiacritics")&&s.useDiacriticsPlugin?l=e.Paginator.removeDiacritics(l.toString()):l=l.toString();if(r.cmp_method==="levenshtein"&&t.has(e.Paginator,"levenshtein")&&s.useLevenshteinPlugin){var h=e.Paginator.levenshtein(l,i);t.defaults(r,{max_distance:0}),h<=r.max_distance&&(c=t.uniq(u))}else c=l.match(f);c=t.map(c,function(e){return e.toString().toLowerCase()}),t.each(c,function(e){o.push(e)})}}),o=t.uniq(t.without(o,"")),t.isEmpty(t.difference(u,o))&&l.push(n)}),l},info:function(){var e=this,t={},n=e.sortedAndFilteredModels?e.sortedAndFilteredModels.length:e.length,r=Math.ceil(n/e.perPage);return t={totalUnfilteredRecords:e.origModels.length,totalRecords:n,currentPage:e.currentPage,perPage:this.perPage,totalPages:r,lastPage:r,previous:!1,next:!1,startRecord:n===0?0:(e.currentPage-1)*this.perPage+1,endRecord:Math.min(n,e.currentPage*this.perPage)},e.currentPage>1&&(t.previous=e.currentPage-1),e.currentPage<t.totalPages&&(t.next=e.currentPage+1),t.pageSet=e.setPagination(t),e.information=t,t},setPagination:function(e){var t=[],n=0,r=0,i=3,s=i*2,o=Math.ceil(e.totalRecords/e.perPage);if(o>1)if(o<7+s)for(n=1,r=o;n<=r;n++)t.push(n);else if(o>5+s)if(e.currentPage<1+s)for(n=1,r=4+s;n<r;n++)t.push(n);else if(o-s>e.currentPage&&e.currentPage>s)for(n=e.currentPage-i;n<=e.currentPage+i;n++)t.push(n);else for(n=o-(2+s);n<=o;n++)t.push(n);return t}}),r.requestPager=e.Collection.extend({sync:function(e,r,i){var s=this;t.defaults(s.paginator_ui,{firstPage:0,currentPage:1,perPage:5,totalPages:10}),t.each(s.paginator_ui,function(e,n){t.isUndefined(s[n])&&(s[n]=s.paginator_ui[n])});var o={};t.each(s.server_api,function(e,n){t.isFunction(e)&&(e=t.bind(e,s),e=e()),o[n]=e});var u=t.clone(s.paginator_core);return t.each(u,function(e,n){t.isFunction(e)&&(e=t.bind(e,s),e=e()),u[n]=e}),u=t.defaults(u,{timeout:25e3,cache:!1,type:"GET",dataType:"jsonp"}),i.data?i.data=decodeURIComponent(n.param(t.extend(o,i.data))):i.data=decodeURIComponent(n.param(o)),u=t.extend(u,{processData:!1,url:t.result(u,"url")},i),n.ajax(u)},requestNextPage:function(e){if(this.currentPage!==undefined)return this.currentPage+=1,this.pager(e);var t=new n.Deferred;return t.reject(),t.promise()},requestPreviousPage:function(e){if(this.currentPage!==undefined)return this.currentPage-=1,this.pager(e);var t=new n.Deferred;return t.reject(),t.promise()},updateOrder:function(e){e!==undefined&&(this.sortField=e,this.pager())},goTo:function(e,t){if(e!==undefined)return this.currentPage=parseInt(e,10),this.pager(t);var r=new n.Deferred;return r.reject(),r.promise()},howManyPer:function(e){e!==undefined&&(this.currentPage=this.firstPage,this.perPage=e,this.pager())},sort:function(){},info:function(){var e={totalRecords:this.totalRecords||0,currentPage:this.currentPage,firstPage:this.firstPage,totalPages:this.totalPages,lastPage:this.totalPages,perPage:this.perPage};return this.information=e,e},pager:function(e){return t.isObject(e)||(e={}),this.fetch(e)},url:function(){return this.paginator_core!==undefined&&this.paginator_core.url!==undefined?this.paginator_core.url:null}}),r}(Backbone,_,jQuery);